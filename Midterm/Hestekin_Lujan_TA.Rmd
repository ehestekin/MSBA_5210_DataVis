---
title: "General Mills Cereal Sales Analysis"
author: "Eric Hestekin, Schyuler Lujan"
date: "2/13/2020"
output: 
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: 3
    toc_float: yes
---

Repo:  https://github.com/ehestekin/MSBA_5210_DataVis

``` {r echo = FALSE}
# Course: 5210 Communicating Data
# Purpose: General Mills Cereal Sales Analysis
# Date: 2/13/20
# Author: Eric Hestekin, Schyuler Lujan
# Repo:  https://github.com/ehestekin/MSBA_5210_DataVis
```

``` {r echo = FALSE, include = FALSE}
# Clear environment of variables and functions
rm(list = ls(all = TRUE)) 

# Clear environmet of packages
if(is.null(sessionInfo()$otherPkgs) == FALSE)lapply(paste("package:", names(sessionInfo()$otherPkgs), sep=""), detach, character.only = TRUE, unload = TRUE)

```

``` {r setup, include = FALSE, warning = FALSE}
# Load Library
library(tidyverse)
library(gridExtra) # Arranging charts
library(janitor)
library(knitr)
library(scales) # Modifying axis tick mark labels on charts
library(GGally) # Dumbbell and lollipop charts
library(stringr) # Cleanup on key columns
```

```{r}
# Turn off scientific notation
options(scipen = 999)
```

# Introduction to research

## Initial expectations / biases

- Not expecting significant seasonal trends, since cereal is a household staple
- Less expensive cereals sell more, more expensive cereals sell less
- More expensive cereals will sell more with promotions relative to without promotions

# Load data and get initial summary

```{r message = FALSE, warning = FALSE}
# Load sales data
sales_df <- read.csv("mtp_sales_data.csv")

# Load product data
product_df <- read.csv("mtp_product_data.csv")
```

# Uni-variate non-graphical analysis
## Look at first 10 rows

```{r message = FALSE, warning = FALSE}
# Look at first 10 rows of sales_df
head(sales_df, 10)

# Look at first 10 rows of product_df
head(product_df, 10)
```

**sales_df**

- `UPC` formatting has periods rather than dashes, so many need cleanup before joining tables
- `iri_key` is the store identifier, so rename later to make it clear

**product_df**

- check if `UPC` variable in `product_df` is unique for that table before joining
- possibly pull text from `brand` variable to separate cereal from brand for cleaner groupings

## Look at structure of both data frames

```{r message = FALSE, warning = FALSE}
# Look at structure of sales_df
str(sales_df)

# Look at structure of product_df
str(product_df)
```

## Data Transformations

```{r}
# Check if UPC in product_df is unique
sum(duplicated(product_df$UPC))

# Key cleanup in sales_df: replace periods with dashes
sales_df$UPC <- str_replace_all(sales_df$UPC, "[.]", "-")

# Key cleanup in product_df: remove first three characters
product_df$UPC <- sub("00-", "", product_df$UPC)

# Left join with sales_df as left table to preserve all sales data
full_df <- left_join(sales_df, product_df, by = c("UPC", "UPC"))

# Check for any null values in joined df
sum(is.na(full_df)) # no null values

# Rename iri_key variable for clarity
full_df <- rename(full_df, "store_key" = iri_key)

# Create new variables; 
full_df <- mutate(full_df, 
                  company = as.factor(
                    ifelse(str_detect(full_df$brand, "KELLOGGS"), "Kellogg",
                           ifelse(str_detect(full_df$brand, "GENERAL MILLS"), "General Mills", "Post"))),
                  total_sales = (units * price),
                  season = (week %/% 14) + 1)

#Note above is integer division where 14 is number of weeks per season plus 1 so that week 13 is put in the first season (similar with week 52)
# The + 1 after the integer division is so seasons go 1 - 4 instead of 0 - 3

```

## Descriptive Statistics

```{r}
# View descriptive statistics to assess factor variables
summary(full_df)
```

**Initial Observations**

*store_key*

- there are a large number of stores, so grouping by stores may not yield useful results

*units*

- mean slightly higher than the mean with outliers, so skewed to the right
- what are the total units sold by brand? 

*price*

- roughly symmetric distribution
- majority of items (75%) are $`r quantile(full_df$price, c(0.75), type = 1)` or less, regardless of brand
- max price of $`r round(max(full_df$price),2)` indicates an outlier
- Maybe useful to look at price/volume for a consistent comparable?
-- Seems to be a wide variety of package sizes which leads to more variety in price/package

*promo*

- majority of sold items (`r (1 - round(mean(full_df$promo),2))*100`%) do not have in-store promotions, so must be mindful of sample sizes

*ad*

- majority of sold items (`r round(sum(full_df$ad == "NONE") / dim(full_df)[1] * 100,2)`%) don't have ads

*volume*

- mean and median are about the same; use either as measure of central tendency
- majority of items (75%) are `r quantile(full_df$volume, c(0.75), type = 1)` or less

*flavor*

- regular and toasted are the top two flavors

*package*

- `r round(sum(full_df$package == "BOX") / dim(full_df)[1] * 100,2)`% of observations come in a box

# Uni-variate graphical analysis

## Price

```{r}
# Price
grid.arrange(
  ggplot(data = full_df, mapping = aes(x = 1, y = price)) +
    geom_boxplot() +
    coord_flip(),
  
  ggplot(data = full_df, mapping = aes(x = price)) +
    geom_histogram(bins = 50),
  
  ncol = 1
)
```

``` {r}
#Compare above to price/volume
# NOTE/TODO: Not positive volume column is consistent unit.  Verify
grid.arrange(
  ggplot(data = full_df, mapping = aes(x = 1, y = price/volume)) +
    geom_boxplot() +
    coord_flip(),
  
  ggplot(full_df, mapping = aes(x = price/volume)) +
    geom_histogram(bins = 50),
  
  ncol = 1
)

```

Maybe more symmetrical main distribution, but maybe more outliers.
- Due to inconsitent unit of volume?

## Units

```{r}
# Units
grid.arrange(
  ggplot(data = full_df, mapping = aes(x = 1, y = units)) +
    geom_boxplot() +
    coord_flip(),
  
  ggplot(data = full_df, mapping = aes(x = units)) +
    geom_histogram(bins = 50),
  
  ncol = 1
)
```

Certainly not symmetrical.  Makes sense as it implies it's most common to sell fewer units in a week. 

## Volume

```{r}
# volume
grid.arrange(
  ggplot(data = full_df, mapping = aes(x = 1, y = volume)) +
    geom_boxplot() +
    coord_flip(),
  
  ggplot(data = full_df, mapping = aes(x = volume)) +
    geom_histogram(bins = 50),
  
  ncol = 1
)
```

## Brand

```{r}
# Count by brand
full_df %>% 
  group_by(brand) %>% 
  summarize(n_brand = n()) %>% 
  ggplot(mapping = aes(x = reorder(brand, n_brand), y = n_brand)) +
  geom_bar(stat = 'identity') +
  xlab('Brand') +
  ylab('Count') +
  coord_flip()
```

## Flavor

```{r}
# Count by flavor
ggplot(data = full_df, mapping = aes(x = flavor)) +
  geom_bar()
#alternatively
#ggplot(data = full_df, mapping = aes(x = flavor)) + 
#   geom_histogram(stat = 'count')

```

## Company

```{r}
# Count by company
ggplot(data = full_df, mapping = aes(x = company)) +
  geom_bar()
```

# Multi-variate non-graphical analysis

## Categorical variables only

### Promo vs. non-promo counts

```{r}
# Counts of promotional v. non-promotional observations to check sample sizes
full_df %>% 
  group_by(brand, promo) %>% 
  summarise(count = n()) %>% 
  pivot_wider(names_from = promo, values_from = count)
```

## Quantitative variables only

## Categorical and quantitative variables

### Promo vs. non-promo units sold by brand

Want to check the counts by brand to review any potential issues with sample size

```{r}
# Units sold of promotional v. non-promotional by brand 
# For later: lollipop chart, sorted on descending by highest sales? As proportion?
full_df %>% 
  group_by(brand, promo) %>% 
  summarise(total_units = sum(units)) %>% 
  pivot_wider(names_from = promo, values_from = total_units) %>%
  rename("No_Promo" = "0",
         "Promo" = "1")
```

- sample sizes for promotional items by brand look fine

### Sales by company and brand

```{r}
# Sales volume and dollar amount by company
full_df %>%
  group_by(company) %>%
  summarise(units_sold = sum(units),
            p_units = sum(promo * units),
            percent_p_units = (round(p_units/units_sold,4)*100),
            total_sales = sum(total_sales),
            p_sales = sum(promo * units * price),
            percent_p_sales = round(p_sales/total_sales, 4)*100) %>%
  arrange(desc(percent_p_units))

# Sales volume and dollar amount by brand -- graph with fill = company to differentiate brands?
full_df %>% 
  group_by(brand) %>% 
  summarise(total_sales = sum(total_sales),
            p_sales = sum(promo * units * price), # sales that had promos
            percent_p_sales = round(p_sales/total_sales, 4)*100) %>% 
  arrange(desc(total_sales))
```

- General Mills has the lowest percentage of promotional sales (both in units sold and total sales), but second highest in total dollar amount
- Total sales appears to be positively correlated with total units sold; more units sold always yields higher sales
- Some brands have a higher proportion of sales from promotions; generally, ones with the highest proportion of promotional items sold have lowest sales

### Sales across time period, overall and by brand or company

```{r}

grid.arrange(
full_df %>% 
  group_by(brand) %>% 
  summarize(avg_wkly_sales = mean(total_sales),
            all_sales = sum(total_sales)) %>% 
  ggplot(mapping = aes(x = reorder(brand, avg_wkly_sales)
                       , y = avg_wkly_sales)) +
  geom_bar(stat = 'identity') +
  coord_flip(),

full_df %>% 
  group_by(brand) %>% 
  summarize(avg_wkly_sales = mean(total_sales),
            all_sales = sum(total_sales)) %>% 
  ggplot(mapping = aes(x = reorder(brand, avg_wkly_sales), y = all_sales))+
  geom_bar(stat = 'identity')+
  coord_flip(),

ncol = 1)
```

Interesting the difference between the order between average weekly sales and total yearly sales.  Are more stores selling ceratin brands like frosted flakes?

- Did sanity check on this group_by.  Cheerios total sales is equal to avg_weekly * count (seen above in brand section) so method checks out.
-- Maybe there are more versions (UPCs) of some brands?

### Check how many versions of each brand
```{r}
full_df %>% 
  group_by(brand) %>% 
  summarize(n = n_distinct(UPC)) %>% 
  arrange(desc(n))
```

Above table confirms suspision.  There are more unique versions (UPCs) of some cereals such as Froot Loops and Frosted Flakes.

```{r}
# Sales by season
```


### Sales by flavor
``` {r}
full_df %>% 
  group_by(flavor) %>% 
  summarize(sales_flav = sum(total_sales)) %>% 
  ggplot(mapping = aes(x = flavor, y = sales_flav)) +
    geom_bar(stat = 'identity')
  
```

# Multi-variate graphical analysis

```{r}
# Comparing sales across companies
full_df %>% 
  group_by(company) %>% 
  summarise(sales = sum(total_sales)) %>% 
  ggplot(mapping = aes(x = reorder(company, sales), y = sales)) +
  geom_col() +
  coord_flip() +
  labs(title = "Total sales by company")

# Sales comparison with and without promos
full_df %>% 
  group_by(company, promo) %>% 
  summarise(sales = sum(total_sales)) %>% 
  ggplot(mapping = aes(x = reorder(company, sales), y = sales, group = promo)) +
  geom_col() +
  coord_flip() +
  facet_grid(. ~ promo)

# Sales comparison with and without ads
# Excluding those without ads to more easily compare ad categories A and B
full_df %>% 
  group_by(company, ad) %>% 
  filter(ad != "NONE") %>% 
  summarise(sales = sum(total_sales)) %>% 
  ggplot(mapping = aes(x = reorder(company, sales), y = sales, group = ad)) +
  geom_col() +
  geom_text(aes(label = sales)) +
  coord_flip() +
  facet_grid(. ~ ad)

# Sales comparison only for products without ads
full_df %>% 
  group_by(company, ad) %>% 
  filter(ad == "NONE") %>% 
  summarise(sales = sum(total_sales)) %>% 
  ggplot(mapping = aes(x = reorder(company, sales), y = sales)) +
  geom_col() +
  coord_flip() +
  geom_text(aes(label = sales)) +
  labs(title = "Sales by company, no ads",
       y = "Company")

```

- When looking at total sales, sales with/without promos and with/without ads, Kellogg always has the highest, followed by General Mills and then Post. Assess for any changes to this pattern when looking at sales by brand.
- Ad type "A" yields higher sales for Kellogg and General Mills while ad type "B" yields higher sales for Post.

```{r}
# Comparing sales across brands
full_df %>% 
  group_by(brand, company) %>% 
  summarise(sales = sum(total_sales)) %>% 
  ggplot(mapping = aes(x = reorder(brand, sales), y = sales, fill = company)) +
  geom_col() +
  coord_flip() +
  labs(title = "Total sales by brand")

# Sales comparison with and without promos
grid.arrange(
full_df %>% 
  group_by(brand, company, promo) %>% 
  filter(promo == 0) %>% 
  summarise(sales = sum(total_sales)) %>% 
  ggplot(mapping = aes(x = reorder(brand, sales), y = sales, fill = company)) +
  geom_col() +
  labs(title = "Sales by brand, without promos") +
  coord_flip(),

full_df %>% 
  group_by(brand, company, promo) %>% 
  filter(promo == 1) %>% 
  summarise(sales = sum(total_sales)) %>% 
  ggplot(mapping = aes(x = reorder(brand, sales), y = sales, fill = company)) +
  geom_col() +
  labs(title = "Sales by brand, with promos") +
  coord_flip(),

nrow = 2)

# Sales comparison with and without ads
# Excluding those without ads to more easily compare ad categories A and B
grid.arrange(
full_df %>% 
  group_by(brand, company, ad) %>% 
  filter(ad == "A") %>% 
  summarise(sales = sum(total_sales)) %>% 
  ggplot(mapping = aes(x = reorder(brand, sales), y = sales, fill = company)) +
  geom_col() +
  labs(title = "Sales by brand, ad type A") +
  coord_flip(),

full_df %>% 
  group_by(brand, company, ad) %>% 
  filter(ad == "B") %>% 
  summarise(sales = sum(total_sales)) %>% 
  ggplot(mapping = aes(x = reorder(brand, sales), y = sales, fill = company)) +
  geom_col() +
  labs(title = "Sales by brand, ad type B") +
  coord_flip(),

ncol = 1)

# Sales comparison only for products without ads
full_df %>% 
  group_by(brand, company, ad) %>% 
  filter(ad == "NONE") %>% 
  summarise(sales = sum(total_sales)) %>% 
  ggplot(mapping = aes(x = reorder(brand, sales), y = sales, fill = company)) +
  geom_col() +
  labs(title = "Sales by brand, no ad") +
  coord_flip()

```

# Detailed exploratory analysis

# Statistical analysis

# Regression analysis

# Conclusions and final visualizations

# TEST COMMIT CHANGE

