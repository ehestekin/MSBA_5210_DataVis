---
title: "General Mills Cereal Sales Analysis"
author: "Eric Hestekin, Schyuler Lujan"
date: "2/13/2020"
output: 
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: 3
    toc_float: yes
---

Repo:  https://github.com/ehestekin/MSBA_5210_DataVis

``` {r echo = FALSE}
# Course: 5210 Communicating Data
# Purpose: General Mills Cereal Sales Analysis
# Date: 2/13/20
# Author: Eric Hestekin, Schyuler Lujan
# Repo:  https://github.com/ehestekin/MSBA_5210_DataVis
```

``` {r echo = FALSE, include = FALSE}
# Clear environment of variables and functions
rm(list = ls(all = TRUE)) 

# Clear environmet of packages
if(is.null(sessionInfo()$otherPkgs) == FALSE)lapply(paste("package:", names(sessionInfo()$otherPkgs), sep=""), detach, character.only = TRUE, unload = TRUE)

```

``` {r setup, include = FALSE, warning = FALSE}
# Load Library
library(tidyverse)
library(gridExtra) # Arranging charts
library(janitor)
library(knitr)
library(scales) # Modifying axis tick mark labels on charts
library(ggalt) # Dumbbell and lollipop charts
library(stringr) # Cleanup on key columns
```

```{r}
# Turn off scientific notation
options(scipen = 999)
```

# Introduction to research

## Initial expectations / biases

- Not expecting significant seasonal trends, since cereal is a household staple
- Less expensive cereals sell more, more expensive cereals sell less
- More expensive cereals will sell more with promotions relative to without promotions

# Load data and get initial summary

```{r message = FALSE, warning = FALSE}
# Load sales data
sales_df <- read.csv("mtp_sales_data.csv")

# Load product data
product_df <- read.csv("mtp_product_data.csv")
```

# Uni-variate non-graphical analysis
## Look at first 10 rows

```{r message = FALSE, warning = FALSE}
# Look at first 10 rows of sales_df
head(sales_df, 10)

# Look at first 10 rows of product_df
head(product_df, 10)
```

**sales_df**

- `UPC` formatting has periods rather than dashes, so many need cleanup before joining tables
- `iri_key` is the store identifier, so rename later to make it clear

**product_df**

- check if `UPC` variable in `product_df` is unique for that table before joining
- possibly pull text from `brand` variable to separate cereal from brand for cleaner groupings

## Look at structure

```{r message = FALSE, warning = FALSE}
# Look at structure of sales_df
str(sales_df)

# Look at structure of product_df
str(product_df)

# Count number of unique UPC on both data frames
n_distinct(sales_df$UPC)

n_distinct(product_df$UPC)
```

## Data Transformations

```{r}
# Check if UPC in product_df is unique
sum(duplicated(product_df$UPC))

# Key cleanup in sales_df: replace periods with dashes
sales_df$UPC <- str_replace_all(sales_df$UPC, "[.]", "-")

# Key cleanup in product_df: remove first three characters
product_df$UPC <- sub("00-", "", product_df$UPC)

# Left join with sales_df as left table to preserve all sales data
full_df <- left_join(sales_df, product_df, by = c("UPC", "UPC"))

# Check for any null values in joined df
sum(is.na(full_df)) # no null values

# Rename iri_key variable for clarity
full_df <- rename(full_df, "store_key" = iri_key)

# Create new variables; 
full_df <- mutate(full_df, 
                  company = as.factor(
                    ifelse(str_detect(full_df$brand, "KELLOGGS"), "Kellogg",
                           ifelse(str_detect(full_df$brand, "GENERAL MILLS"), "General Mills", "Post"))),
                  total_sales = (units * price),
                  season = (week %/% 14) + 1)

#Note above is integer division where 14 is number of weeks per season plus 1 so that week 13 is put in the first season (similar with week 52)
# The + 1 after the integer division is so seasons go 1 - 4 instead of 0 - 3

#realized also want total volumes too
full_df <- full_df %>% mutate(total_volume = units * volume)
```

## Descriptive Statistics

```{r}
# View descriptive statistics to assess factor variables
summary(full_df)
```

**Initial Observations**

*store_key*

- there are a large number of stores, so grouping by stores may not yield useful results

*units*

- mean slightly higher than the mean with outliers, so skewed to the right
- what are the total units sold by brand? 

*price*

- roughly symmetric distribution
- majority of items (75%) are $`r quantile(full_df$price, c(0.75), type = 1)` or less, regardless of brand
- max price of $`r round(max(full_df$price),2)` indicates an outlier
- Maybe useful to look at price/volume for a consistent comparable?
-- Seems to be a wide variety of package sizes which leads to more variety in price/package

*promo*

- majority of sold items (`r (1 - round(mean(full_df$promo),2))*100`%) do not have in-store promotions, so must be mindful of sample sizes

*ad*

- majority of sold items (`r round(sum(full_df$ad == "NONE") / dim(full_df)[1] * 100,2)`%) don't have ads

*volume*

- mean and median are about the same; use either as measure of central tendency
- majority of items (75%) are `r quantile(full_df$volume, c(0.75), type = 1)` or less

*flavor*

- regular and toasted are the top two flavors

*package*

- `r round(sum(full_df$package == "BOX") / dim(full_df)[1] * 100,2)`% of observations come in a box

# Uni-variate graphical analysis
## Quantitative Variables

### Price

```{r}
# Price
grid.arrange(
  ggplot(data = full_df, mapping = aes(x = 1, y = price)) +
    geom_boxplot() +
    coord_flip(),
  
  ggplot(data = full_df, mapping = aes(x = price)) +
    geom_histogram(bins = 50),
  
  ncol = 1
)
```

### Price / Volume
``` {r}
#Compare above to price/volume
# NOTE/TODO: Not positive volume column is consistent unit.  Verify
grid.arrange(
  ggplot(data = full_df, mapping = aes(x = 1, y = price/volume)) +
    geom_boxplot() +
    coord_flip(),
  
  ggplot(full_df, mapping = aes(x = price/volume)) +
    geom_histogram(bins = 50),
  
  ncol = 1
)

```

Maybe more symmetrical main distribution, but maybe more outliers.
- Due to inconsitent unit of volume?

### Units

```{r}
# Units
grid.arrange(
  ggplot(data = full_df, mapping = aes(x = 1, y = units)) +
    geom_boxplot() +
    coord_flip(),
  
  ggplot(data = full_df, mapping = aes(x = units)) +
    geom_histogram(bins = 50),
  
  ncol = 1
)
```

Certainly not symmetrical.  Makes sense as it implies it's most common to sell fewer units in a week. 

### Volume

```{r}
# volume
grid.arrange(
  ggplot(data = full_df, mapping = aes(x = 1, y = volume)) +
    geom_boxplot() +
    coord_flip(),
  
  ggplot(data = full_df, mapping = aes(x = volume)) +
    geom_histogram(bins = 50),
  
  ncol = 1
)
```

### Total Sales
```{r}
grid.arrange(
ggplot(data = full_df, mapping = aes(x = 1, y = total_sales)) +
  geom_boxplot() +
  coord_flip(),
  
ggplot(data = full_df, mapping = aes(x = total_sales)) +
  geom_histogram(bins = 50),

nrow = 2)
```

## Categorical Variables

### Brand

```{r}
# Count by brand
full_df %>% 
  group_by(brand) %>% 
  summarize(n_brand = n()) %>% 
  ggplot(mapping = aes(x = reorder(brand, n_brand), y = n_brand)) +
  geom_bar(stat = 'identity') +
  xlab('Brand') +
  ylab('Count') +
  coord_flip()
```

### Flavor

```{r}
# Count by flavor
ggplot(data = full_df, mapping = aes(x = flavor)) +
  geom_bar()
#alternatively
#ggplot(data = full_df, mapping = aes(x = flavor)) + 
#   geom_histogram(stat = 'count')

```

### Company

```{r}
# Count by company
ggplot(data = full_df, mapping = aes(x = company)) +
  geom_bar()
```

### Ads

```{r}
ggplot(data = full_df, mapping = aes(x = ad)) +
  geom_bar()
  
```

- graph matches the descriptive statistics; majority of observations do not have ads
- Ad type "A" is slightly more than type "B"

# Multi-variate non-graphical analysis

## Categorical Variables

### Promos by brand

Check sample sizes within each brand. Look at proportion of promo observations within each brand and compare across brands. Do some brands have a higher proportion of promos than others?

```{r}
# Counts of promotional v. non-promotional observations
full_df %>% 
  tabyl(brand, promo) %>% 
  adorn_totals(where = c("row", "col"))

# Proportions of promotional v. non-promotional within brands
full_df %>% 
  tabyl(brand, promo) %>% 
  adorn_totals(where = c("row", "col")) %>% 
  adorn_percentages(denominator = "row") %>% 
  adorn_rounding(digits = 2)
```

- counts and sample sizes look fine for each brand, but watch counts for any addt'l cross-tabs
- proportion of promos pretty similar across brands, but with some clusters of high and low values

- brands with highest proportion of promos (>=0.25):
  - cocoa puffs, cocoa krispies, smart start, special k


- brands with lowest proportion of promos (<=0.20):
  - cheerios, cinnamon toast, kix, lucky charms, raisin bran

- what do these groupings have in common?

### Ad type by brand

```{r}
# Counts of observations for ad types A, B, and NONE by brand
full_df %>% 
  tabyl(brand, ad) %>% 
  adorn_totals(where = c("row", "col"))

# Use for graphing?
# full_df %>% 
#   group_by(brand, ad) %>% 
#   summarise(n = n()) %>% 
#   pivot_wider(names_from = ad, values_from = n)
```

- sample sizes are a bit lower for ad types A and B but still >30
- for each brand, the majority have no ads; what are the differences between ad types A and B?

```{r}
# Proportions for ad types A, B, excluding NONE to better compare between ads
full_df %>% 
  filter(ad != "NONE") %>% 
  tabyl(brand, ad) %>% 
  adorn_totals(where = c("row", "col")) %>% 
  adorn_percentages(denominator = "row") %>% 
  adorn_rounding(digits = 2)
```

- roughly a 60/40 split between ad types A and B, with most brands favoring ad type A
- exception is Post Grape Nuts, which favors ad type B
- does ad A yield better sales across brands?

### Flavor by company

```{r}
# Counts of observations by company and flavor
full_df %>% 
  tabyl(flavor, company) %>% 
  adorn_totals(where = c("row", "col"))

# Proportions as percentage of flavor total
full_df %>% 
  tabyl(flavor, company) %>% 
  adorn_totals(where = c("row", "col")) %>% 
  adorn_percentages(denominator = "row") %>% 
  adorn_rounding(digits = 2)

# Use for graphing?
# full_df %>% 
#   group_by(company, flavor) %>% 
#   summarise(n = n()) %>% 
#   pivot_wider(names_from = company, values_from = n)
```

- General Mills is the only company with cinnamon toast flavor
- For Regular flavor (the most popular flavor) General Mills has the lowest count of the 3 brands
- General Mills competes directly with Kellogg only on cocoa and toasted flavors

### Sales by company and brand

```{r}
# Sales volume and dollar amount by company
full_df %>%
  group_by(company) %>%
  summarise(units_sold = sum(units),
            p_units = sum(promo * units),
            percent_p_units = (round(p_units/units_sold,4)*100),
            total_sales = sum(total_sales),
            p_sales = sum(promo * units * price),
            percent_p_sales = round(p_sales/total_sales, 4)*100) %>%
  arrange(desc(percent_p_units))

# Sales volume and dollar amount by brand -- graph with fill = company to differentiate brands?
full_df %>% 
  group_by(brand) %>% 
  summarise(total_sales = sum(total_sales),
            p_sales = sum(promo * units * price), # sales that had promos
            percent_p_sales = round(p_sales/total_sales, 4)*100) %>% 
  arrange(desc(total_sales))
```

- General Mills has the lowest percentage of promotional sales (both in units sold and total sales), but second highest in total dollar amount
- Total sales appears to be positively correlated with total units sold; more units sold always yields higher sales
- Some brands have a higher proportion of sales from promotions; generally, ones with the highest proportion of promotional sales have lowest total sales, with Kix as the exception

### Sales across time period, overall and by brand or company

```{r}

grid.arrange(
full_df %>% 
  group_by(brand, company) %>% 
  summarize(avg_wkly_sales = mean(total_sales),
            all_sales = sum(total_sales)) %>% 
  ggplot(mapping = aes(x = reorder(brand, avg_wkly_sales)
                       , y = avg_wkly_sales, fill = company)) +
  geom_bar(stat = 'identity') +
  coord_flip(),

full_df %>% 
  group_by(brand, company) %>% 
  summarize(avg_wkly_sales = mean(total_sales),
            all_sales = sum(total_sales)) %>% 
  ggplot(mapping = aes(x = reorder(brand, avg_wkly_sales), y = all_sales, fill = company))+
  geom_bar(stat = 'identity')+
  coord_flip(),

ncol = 1)
```

Interesting the difference between the order between average weekly sales and total yearly sales.  Are more stores selling ceratin brands like frosted flakes?

- Did sanity check on this group_by.  Cheerios total sales is equal to avg_weekly * count (seen above in brand section) so method checks out.
-- Maybe there are more versions (UPCs) of some brands?

#### Check how many versions of each brand
```{r}
full_df %>% 
  group_by(brand) %>% 
  summarize(n = n_distinct(UPC)) %>% 
  arrange(desc(n))
```

Above table confirms suspision.  There are more unique versions (UPCs) of some cereals such as Froot Loops and Frosted Flakes.

### Sales by season

```{r}
# Total sales by company and season
full_df %>% 
  group_by(company, season) %>% 
  summarise(sales = sum(total_sales)) %>% 
  pivot_wider(names_from = season, values_from = sales)

# Total sales by brand and season
full_df %>% 
  group_by(brand, season) %>% 
  summarise(sales = sum(total_sales)) %>% 
  pivot_wider(names_from = season, values_from = sales)

# Total sales by flavor and season
full_df %>% 
  group_by(flavor, season) %>% 
  summarise(sales = sum(total_sales)) %>% 
  pivot_wider(names_from = season, values_from = sales)
```

- sales seem to drop in season 4

### Sales by flavor

``` {r}
full_df %>% 
  group_by(flavor) %>% 
  summarize(sales_flav = sum(total_sales)) %>% 
  ggplot(mapping = aes(x = flavor, y = sales_flav)) +
    geom_bar(stat = 'identity')
  
```

## Quantitative Variables

Correlation table of quantitative variables
```{r}
full_df %>% 
  select_if(is.numeric) %>% 
  cor() %>% 
  round(2)
```

- moderately strong correlations:

  - negative association between price and promo; correlation = `r round(cor(full_df$price, full_df$promo),2)`
  - positive association between price and volume; correlation = `r round(cor(full_df$price, full_df$volume),2)`

- weak correlations:

  - positive associaton between promo and units: correlation = `r round(cor(full_df$promo, full_df$units),2)`

# Multi-variate graphical analysis

``` {r}
#interested in price/volume between promo and no promo for each company
grid.arrange(
  full_df[full_df$promo == 0,] %>% 
    ggplot(mapping = aes(x = volume * units, y = total_sales, color = company)) +
    geom_smooth() +
    scale_x_continuous('Total Volume', limits = c(0,80)) +
    scale_y_continuous('Total Sales', limits = c(0, 125)),
  
  full_df[full_df$promo == 1,] %>% 
    ggplot(mapping = aes(x = volume * units, y = total_sales, color = company)) +
    geom_smooth() +
    scale_x_continuous('Total Volume',limits = c(0,80)) +
    scale_y_continuous('Total Sales', limits = c(0, 125)),
  
  ncol = 1
)
  
  
```

GM is getting beat on Price/Volume in both promo and non-promo sales

## Categorical Variables

### Sales comparison across promotions

```{r}
# Comparing sales across companies
full_df %>% 
  group_by(company) %>% 
  summarise(sales = sum(total_sales)) %>% 
  ggplot(mapping = aes(x = reorder(company, sales), y = sales)) +
  geom_col() +
  coord_flip() +
  labs(title = "Total sales by company")

# Sales comparison with and without promos
full_df %>% 
  group_by(company, promo) %>% 
  summarise(sales = sum(total_sales)) %>% 
  ggplot(mapping = aes(x = reorder(company, sales), y = sales, group = promo)) +
  geom_col() +
  coord_flip() +
  facet_grid(. ~ promo)

# Sales comparison with and without ads
# Excluding those without ads to more easily compare ad categories A and B
full_df %>% 
  group_by(company, ad) %>% 
  filter(ad != "NONE") %>% 
  summarise(sales = sum(total_sales)) %>% 
  ggplot(mapping = aes(x = reorder(company, sales), y = sales, group = ad)) +
  geom_col() +
  geom_text(aes(label = sales)) +
  coord_flip() +
  facet_grid(. ~ ad)

# Sales comparison only for products without ads
full_df %>% 
  group_by(company, ad) %>% 
  filter(ad == "NONE") %>% 
  summarise(sales = sum(total_sales)) %>% 
  ggplot(mapping = aes(x = reorder(company, sales), y = sales)) +
  geom_col() +
  coord_flip() +
  geom_text(aes(label = sales)) +
  labs(title = "Sales by company, no ads",
       y = "Company")

```

- When looking at total sales, sales with/without promos and with/without ads, Kellogg always has the highest, followed by General Mills and then Post. Assess for any changes to this pattern when looking at sales by brand.
- When there are ads, type "A" yields higher sales for Kellogg and General Mills while ad type "B" yields higher sales for Post.

### Sales across brands by promotions and ads

```{r}
# Comparing total sales across brands
full_df %>% 
  group_by(brand, company) %>% 
  summarise(sales = sum(total_sales)) %>% 
  ggplot(mapping = aes(x = reorder(brand, sales), y = sales, fill = company)) +
  geom_col() +
  coord_flip() +
  labs(title = "Total sales by brand")

# Sales comparison with and without promos
grid.arrange(
full_df %>% 
  group_by(brand, company, promo) %>% 
  filter(promo == 0) %>% 
  summarise(sales = sum(total_sales)) %>% 
  ggplot(mapping = aes(x = reorder(brand, sales), y = sales, fill = company)) +
  geom_col() +
  labs(title = "Sales by brand, without promos") +
  coord_flip(),

full_df %>% 
  group_by(brand, company, promo) %>% 
  filter(promo == 1) %>% 
  summarise(sales = sum(total_sales)) %>% 
  ggplot(mapping = aes(x = reorder(brand, sales), y = sales, fill = company)) +
  geom_col() +
  labs(title = "Sales by brand, with promos") +
  coord_flip(),

nrow = 2)

# Sales comparison across ad types
# Excluding those without ads to more easily compare ad categories A and B
grid.arrange(
full_df %>% 
  group_by(brand, company, ad) %>% 
  filter(ad == "A") %>% 
  summarise(sales = sum(total_sales)) %>% 
  ggplot(mapping = aes(x = reorder(brand, sales), y = sales, fill = company)) +
  geom_col() +
  labs(title = "Sales by brand, ad type A",
       x = "Brand") +
  coord_flip(),

full_df %>% 
  group_by(brand, company, ad) %>% 
  filter(ad == "B") %>% 
  summarise(sales = sum(total_sales)) %>% 
  ggplot(mapping = aes(x = reorder(brand, sales), y = sales, fill = company)) +
  geom_col() +
  labs(title = "Sales by brand, ad type B",
       x = "Brand") +
  coord_flip(),

ncol = 1)

# Sales comparison only for products without ads
full_df %>% 
  group_by(brand, company, ad) %>% 
  filter(ad == "NONE") %>% 
  summarise(sales = sum(total_sales)) %>% 
  ggplot(mapping = aes(x = reorder(brand, sales), y = sales, fill = company)) +
  geom_col() +
  labs(title = "Sales by brand, no ad") +
  coord_flip()

```

Total Sales

- For total sales, three General Mills brands are in the top 5 and two are in the bottom 5
- Does this same pattern hold across promos and ads?

Promotions

- Without promos, General Mills sales are higher relative to other brands
- With promos, General Mills sales are lower relative to other brands

Ads

- General Mills brands do worse relative to other brands with ad type "B"
- Also do better relative to other brands when there are no ads

### Sales by Season

```{r}
# What is the proportion of sales attributed to each season within brand?
full_df %>% 
  group_by(brand, season) %>% 
  summarise(sales = sum(total_sales)) %>% 
  ggplot(mapping = aes(x = brand, y = sales, fill = season)) +
  geom_col(position = "fill") +
  coord_flip()

```

### Promos and Ads by Season for each company

```{r}
#Do some companies run more promotions at certain times of year?
#Number of sales each season
# full_df %>% 
#   ggplot(mapping = aes(x = season, fill = company)) +
#   geom_bar(position = 'dodge')

grid.arrange(
full_df %>% 
  group_by(company,season) %>% 
  summarize(n = n()) %>% 
  ggplot(mapping = aes(x = season, y = n, color = company)) +
  geom_line(),

full_df %>% 
  group_by(company, season) %>% 
  summarize(n = n(), perc_promo = sum(promo)/n) %>% 
  ggplot(mapping = aes(x = season, y = perc_promo, fill = company)) +
  geom_bar(position = 'dodge', stat = 'identity'),

ncol = 1
)
```

## Quantitative Variables

## Categorical and Quantitative Variables

# Detailed exploratory analysis

# Statistical analysis

Questions to answer:
+Significance of promos/ads on sales
+Seasonal differences signifcant?
+Price differences

```{r}
#check seasonal differences first
z <- qnorm(0.975)

full_df %>% 
  group_by(company, season) %>% 
  summarize(avg_sales = mean(total_sales), sd = sd(total_sales), 
            n = n(), ci = z * sd/sqrt(n)) %>% 
  ggplot(mapping = aes(x = season, y = avg_sales, color = company)) +
  geom_line() +
  geom_errorbar(aes(ymin = avg_sales - ci, ymax = avg_sales + ci), 
                    width = 0.9, color = 'black')

#very large standard deviations mean we cannot reject the null hypothesis that the average sales vary significantly between seasons.  
#TODO: Need to test median as sales are right skewed

```

```{r}
#next look at total volume and total sales between promos and not
z <- qnorm(0.975)

full_df %>% 
  mutate(total_volume = units * volume) %>% 
  group_by(company, promo) %>% 
  summarize(avg_vol = mean(total_volume), avg_sales = mean(total_sales),
            n = n(), sd_vol = sd(total_volume), sd_sales = sd(total_sales),
            ci_vol = z * sd_vol/sqrt(n), ci_sales = z * sd_sales/sqrt(n)) %>% 
  ggplot(mapping = aes(x = company, y = avg_vol, fill = as.factor(promo))) +
  geom_bar(stat = 'identity', position = 'dodge') +
  geom_errorbar(aes(ymin = avg_vol - ci_vol, ymax = avg_vol + ci_vol),
                width = 0.75, position = position_dodge(0.9))
  
#note feels sloppy to copy this data setup part but piping another ggplot doesn't work
full_df %>% 
  mutate(total_volume = units * volume) %>% 
  group_by(company, promo) %>% 
  summarize(avg_vol = mean(total_volume), avg_sales = mean(total_sales),
            n = n(), sd_vol = sd(total_volume), sd_sales = sd(total_sales),
            ci_vol = z * sd_vol/sqrt(n), ci_sales = z * sd_sales/sqrt(n)) %>% 
  ggplot(mapping = aes(x = company, y = avg_sales, fill = as.factor(promo))) +
  geom_bar(stat = 'identity', position = 'dodge') +
  geom_errorbar(aes(ymin = avg_sales - ci_sales, ymax = avg_sales + ci_sales),
                width = 0.75, position = position_dodge(0.9))
    

```
- All companies average significantly higher volumes with promos, but only Kellogg has significantly higher average *sales*

```{r}
#similarly with ads
#realizing might want total volumes more. added mutate to initial section at top
# full_df <- full_df %>% mutate(total_volume = units * volume)
full_df %>% 
  group_by(company, ad) %>% 
  summarize(avg_vol = mean(total_volume),
            n = n(), sd_vol = sd(total_volume),
            ci_vol = z * sd_vol/sqrt(n)) %>% 
  ggplot(mapping = aes(x = company, y = avg_vol, fill = as.factor(ad))) +
  geom_bar(stat = 'identity', position = 'dodge') +
  geom_errorbar(aes(ymin = avg_vol - ci_vol, ymax = avg_vol + ci_vol),
                width = 0.75, position = position_dodge(0.9))

full_df %>% 
  group_by(company, ad) %>% 
  summarize(avg_sales = mean(total_sales),
            n = n(), sd_sales = sd(total_sales),
            ci_sales = z * sd_sales/sqrt(n)) %>% 
  ggplot(mapping = aes(x = company, y = avg_sales, fill = as.factor(ad))) +
  geom_bar(stat = 'identity', position = 'dodge') +
  geom_errorbar(aes(ymin = avg_sales - ci_sales, ymax = avg_sales + ci_sales),
                width = 0.75, position = position_dodge(0.9))

```
- Note ad A and B are not significantly different in volume or sales.
+ Maybe useful to combine them into ad yes/no similar to promo
-Similar to promo, Kellogg is the only company to increase sales with ads
++ What are they doing differently?

```{r}
#Check promo price difference for each brand
full_df %>% 
  group_by(brand, promo) %>% 
  summarize(med_price = median(price),
            n = n(), sd_price = sd(price),
            ci_price = z * sd_price/sqrt(n)) %>% #TODO: Update CI for median
  ggplot(mapping = aes(x = brand, y = med_price, fill = as.factor(promo))) +
  geom_bar(stat = 'identity', position = 'dodge') +
  geom_errorbar(aes(ymin = med_price - ci_price, ymax = med_price + ci_price),
                width = 0.75, position = position_dodge(0.9)) +
  coord_flip()

#do similar but with delta price
full_df %>% 
  group_by(brand, promo) %>% 
  summarize(med_price = median(price)) %>% 
  spread(promo, med_price, sep = '_') %>% 
  mutate(price_dif = promo_0 - promo_1) %>% 
  ggplot(mapping = aes(x = reorder(brand,price_dif), y = price_dif)) +
  geom_bar(stat = 'identity') +
  coord_flip()

full_df %>% 
  group_by(brand, promo) %>% 
  summarize(med_price = median(price)) %>% 
  spread(promo, med_price, sep = '_') %>% 
  mutate(perc_dif = promo_0 / promo_1 - 1) %>% 
  ggplot(mapping = aes(x = reorder(brand,perc_dif), y = perc_dif)) +
  geom_bar(stat = 'identity') +
  coord_flip()

#similar but by company
full_df %>% 
  group_by(company, promo) %>% 
  summarize(med_price = median(price)) %>% 
  spread(promo, med_price, sep = '_') %>% 
  mutate(perc_dif = promo_0 / promo_1 - 1) %>% 
  ggplot(mapping = aes(x = reorder(company,perc_dif), y = perc_dif)) +
  geom_bar(stat = 'identity') +
  coord_flip()

full_df %>% 
  group_by(flavor, company, promo) %>% 
  summarize(med_price = median(price)) %>% 
  spread(promo, med_price, sep = '_') %>% 
  mutate(perc_dif = promo_0 / promo_1 - 1) %>% 
  ggplot(mapping = aes(x = flavor, y = perc_dif, fill = company)) +
  geom_bar(stat = 'identity', position = 'dodge') +
  coord_flip()

full_df %>% 
  group_by(flavor, company, promo) %>% 
  summarize(med_price = median(price)) %>% 
  spread(promo, med_price, sep = '_') %>% 
  mutate(price_dif = promo_0 - promo_1) %>% 
  ggplot(mapping = aes(x = flavor, y = price_dif, fill = company)) +
  geom_bar(stat = 'identity', position = 'dodge') +
  coord_flip()
```
```{r}
#test price difference significance
#first filter arrays for setting up t-test data frames
kellogg_promos <- full_df %>% filter(promo == 1, company == 'Kellogg')
kellogg_norm   <- full_df %>% filter(promo == 0, company == 'Kellogg')

gm_promos <- full_df %>% filter(promo == 1, company == 'General Mills')
gm_norm <- full_df %>% filter(promo == 0, company == 'General Mills')

#calculate promo price below mean
#do per upc and store avgs
# kellogg_mean_prices <- kellogg_norm %>% 
#   group_by(UPC, store_key) %>% 
#   summarize(avg_yrly_price = mean(price))
# 
# kellogg_promos <- left_join(kellogg_promos, kellogg_mean_prices, by = c('UPC', 'store_key')) %>% 
#   mutate(price_dif = avg_yrly_price - price,
#          perc_disc = 1 - price / avg_yrly_price) %>% 
#   na.omit()
# 
# gm_mean_prices <- gm_norm %>% 
#   group_by(UPC, store_key) %>% 
#   summarize(avg_yrly_price = mean(price))
# 
# gm_promos <- left_join(gm_promos, gm_mean_prices, by = c('UPC', 'store_key')) %>% 
#   mutate(price_dif = avg_yrly_price - price,
#          perc_disc = 1 - price / avg_yrly_price) %>% 
#   na.omit()
# 
# #quite a few zeros or negative discounts (~10%) skewing data
# kellogg_promos_gt_0 <- kellogg_promos %>% filter(price_dif > 0)
# gm_promos_gt_0 <- gm_promos %>% filter(price_dif > 0)

t.test(gm_norm$price, kellogg_norm$price)

#better comparison is normalize for volume
t.test(gm_norm$price / gm_norm$volume, kellogg_norm$price / kellogg_norm$volume)

t.test(gm_promos$price / gm_promos$volume, kellogg_promos$price / kellogg_promos$volume)

#test percentage of sales from promos
kellogg_all <- full_df %>% filter(company =='Kellogg')
gm_all      <- full_df %>% filter(company == 'General Mills')

# t.test(kellogg_all$promo * kellogg_all$total_sales / , gm_all$promo * gm_all$total_sales)

# t.test(kellogg_promos_gt_0$price_dif, gm_promos_gt_0$price_dif)
```
# Regression analysis

# Conclusions and final visualizations

``` {r}
#plot discount levels for GM vs Kellogg in competing flavors

full_df %>%
  group_by(flavor, company, promo) %>% 
  summarize(avg_price_per_vol = mean(price / volume)) %>% 
  ggplot(mapping = aes(x = flavor, y = avg_price_per_vol, 
                       fill = as.factor(promo))) +    
  geom_bar(stat = 'identity', position = 'dodge') +
  coord_flip()

#filter FRUIT because no GM brand in that flavor
kellogg_fig_df <- full_df %>% 
  filter(company == 'Kellogg', flavor != 'FRUIT') %>% 
  group_by(flavor, promo) %>% 
  summarize(avg_price_per_vol = mean(price / volume)) %>% 
  spread(promo, avg_price_per_vol, sep = '_')

#filter CINNAMON TOAST because no Kellogg brand in that flavor
gm_fig_df <- full_df %>% 
  filter(company == 'General Mills', flavor != 'CINNAMON TOAST') %>% 
  group_by(flavor, promo) %>% 
  summarize(avg_price_per_vol = mean(price / volume)) %>% 
  spread(promo, avg_price_per_vol, sep = '_')

# fig <- ggplot(kellogg_fig_df) +
#   geom_dumbbell(mapping = aes(y = flavor, x = promo_1, xend = promo_0)) +
#   geom_dumbbell(data = gm_fig_df, mapping = aes(y = flavor, x = promo_1, xend = promo_0), color = 'green') +
#   position_dodge(0.7)

full_df %>% 
  filter(company != 'Post') %>% 
  group_by(company, promo) %>% 
  summarize(avg_price_per_vol = mean(price / volume)) %>% 
  spread(promo, avg_price_per_vol, sep = '_') %>% 
  ggplot() +
   geom_dumbbell(mapping = aes(y = company, x = promo_1, xend = promo_0),
                 colour = 'grey70',
                 colour_x = '#385CB7',
                 colour_xend = '#001a33',
                 size = 1.75) +
  my_theme

full_df %>% 
  filter(company != 'Post') %>% 
  group_by(company, promo) %>% 
  summarize(avg_price_per_vol = mean(price / volume)) %>% 
  ggplot() +
  geom_line(mapping = aes(x = promo, y = avg_price_per_vol, color = company)) +
  scale_colour_manual(values = c('#385cb7', 'grey70'), labels = c('General Mills', 'Kellogg')) +
  geom_point(mapping = aes(x = promo, y = avg_price_per_vol)) +
  my_theme

full_df %>% 
  filter(company != 'Post') %>% 
  group_by(company, promo) %>% 
  summarize(avg_price_per_vol = mean(price / volume)) %>% 
  spread(promo, avg_price_per_vol, sep = '_') %>% 
  ggplot() +
   geom_dumbbell(mapping = aes(y = company, x = c(0,0), xend = promo_0 - promo_1),
                 colour = 'grey70',
                 colour_x = '#385CB7',
                 colour_xend = '#001a33',
                 size = 1.75) +
  geom_text(mapping = aes(x = promo_0 - promo_1, y = c(1.2, 2.2)), label = c( '+$0.94','+$0.81\n(Non-promo price)'), color = '#001a33') +
  geom_text(mapping = aes(x = c(0,0.04), y = c(1.2, 2.2)), label = c('$3.76', '$3.51\n(Promo Price)'), color = '#385CB7') +
  labs(title = 'General Mills average discount larger than Kellogg',
       subtitle = 'Promo price also significantly higher*',
       caption = '*Prices shown in price per unit volume ($/lb)') +
  theme(panel.border = element_blank(),
        panel.background = element_blank(),
        axis.ticks.y = element_blank(),
        axis.line.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.title = element_text(color = "#808080", size = 18, face = "bold"),
        plot.subtitle = element_text(color = "#808080", size = 14, face = "plain"),
        axis.text.x = element_blank(),
        axis.text.y = element_text(color = "#808080", size = 12),
        axis.title = element_text(color = "#808080", size = 11, face = "plain"),
        legend.title = element_text(color = "#808080", size = 12, face = "plain"),
        legend.text = element_text(color = "#808080", size = 12, face = "plain"),
        plot.caption = element_text(color = "#808080", size = 10, face = "plain", margin = margin(t=10))
        )
  
         
```


